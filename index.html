<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜æ¾æ—…éŠå³æ™‚åŒæ­¥æ‰‹å†Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBA6MsDbbg_mqeLzliJfN1DyrFmUd_CrKo",
            authDomain: "takamatsu12191221.firebaseapp.com",
            databaseURL: "https://takamatsu12191221-default-rtdb.firebaseio.com",
            projectId: "takamatsu12191221",
            storageBucket: "takamatsu12191221.firebasestorage.app",
            messagingSenderId: "701975778652",
            appId: "1:701975778652:web:030547b85044b2cad75d99",
            measurementId: "G-ZKWE4934GZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tripRef = ref(db, 'takamatsu_trip');

        onValue(tripRef, (snapshot) => {
            const data = snapshot.val() || { names: {a: "æˆå“¡ A", b: "æˆå“¡ B"}, itinerary: {}, expenses: {a: 0, b: 0}, expense_logs: {} };
            renderUI(data);
        });

        function renderUI(data) {
            // æ›´æ–°å§“å
            document.getElementById('nameA').value = data.names?.a || "æˆå“¡ A";
            document.getElementById('nameB').value = data.names?.b || "æˆå“¡ B";
            document.querySelectorAll('.display-name-a').forEach(el => el.innerText = data.names?.a || "æˆå“¡ A");
            document.querySelectorAll('.display-name-b').forEach(el => el.innerText = data.names?.b || "æˆå“¡ B");
            
            // æ›´æ–°ç¸½é¡
            document.getElementById('totalA').innerText = `Â¥${(data.expenses?.a || 0).toLocaleString()}`;
            document.getElementById('totalB').innerText = `Â¥${(data.expenses?.b || 0).toLocaleString()}`;

            // æ›´æ–°è¡Œç¨‹
            for (let day = 1; day <= 3; day++) {
                const listEl = document.getElementById(`list-day${day}`);
                const dayData = data.itinerary ? data.itinerary[`day${day}`] : null;
                listEl.innerHTML = "";
                if (dayData) {
                    const items = Object.entries(dayData).map(([id, val]) => ({ id, ...val }));
                    items.sort((a, b) => a.time.localeCompare(b.time));
                    items.forEach(item => {
                        listEl.innerHTML += `
                            <div class="flex items-center justify-between bg-white p-3 rounded-lg border-l-4 border-[#B4A582] mb-2 shadow-sm">
                                <div><span class="font-bold mr-3 text-[#B4A582]">${item.time}</span><span class="text-gray-700">${item.loc}</span></div>
                                <button onclick="window.deleteItem(${day}, '${item.id}')" class="text-gray-300 px-2">âœ•</button>
                            </div>`;
                    });
                }
            }

            // æ›´æ–°è²»ç”¨é …ç›®æ¸…å–®
            const logEl = document.getElementById('expense-logs');
            logEl.innerHTML = "";
            if (data.expense_logs) {
                const logs = Object.entries(data.expense_logs).reverse(); // æœ€æ–°é¡¯ç¤ºåœ¨æœ€å‰
                logs.forEach(([id, log]) => {
                    logEl.innerHTML += `
                        <div class="flex justify-between text-sm py-2 border-b border-[#B4A582]/10">
                            <span class="text-gray-600">${log.item} (${log.payer === 'A' ? (data.names?.a || 'A') : (data.names?.b || 'B')})</span>
                            <span class="font-bold text-[#B4A582]">Â¥${log.amount.toLocaleString()}</span>
                        </div>`;
                });
            }
        }

        window.updateNames = () => {
            set(ref(db, 'takamatsu_trip/names'), {
                a: document.getElementById('nameA').value || "æˆå“¡ A",
                b: document.getElementById('nameB').value || "æˆå“¡ B"
            });
        };

        window.addItem = (day) => {
            const time = document.getElementById(`time-day${day}`).value;
            const loc = document.getElementById(`loc-day${day}`).value;
            if(!time || !loc) return;
            push(ref(db, `takamatsu_trip/itinerary/day${day}`), { time, loc });
            document.getElementById(`loc-day${day}`).value = "";
        };

        window.deleteItem = (day, id) => {
            remove(ref(db, `takamatsu_trip/itinerary/day${day}/${id}`));
        };

        window.addExpense = () => {
            const payer = document.getElementById('payerSelect').value;
            const item = document.getElementById('expItem').value || "æœªå‘½åæ”¯å‡º";
            const amount = parseFloat(document.getElementById('expAmount').value);
            if(isNaN(amount)) return;
            
            // 1. å¢åŠ ç¸½é¡
            const totalPath = `takamatsu_trip/expenses/${payer.toLowerCase()}`;
            onValue(ref(db, totalPath), (snapshot) => {
                const current = snapshot.val() || 0;
                set(ref(db, totalPath), current + amount);
            }, { onlyOnce: true });

            // 2. è¨˜éŒ„è©³ç´°æ¸…å–®
            push(ref(db, 'takamatsu_trip/expense_logs'), {
                payer, item, amount, time: Date.now()
            });
            
            document.getElementById('expItem').value = "";
            document.getElementById('expAmount').value = "";
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FFFFFF; color: #B4A582; min-height: 100vh; }
        .glass-card { background: rgba(180, 165, 130, 0.08); border: 1px solid rgba(180, 165, 130, 0.2); border-radius: 1.5rem; padding: 1.5rem; margin-bottom: 1.5rem; }
        input, select {
            background-color: #fcfbf9 !important; border: 1px solid rgba(180, 165, 130, 0.3) !important;
            color: #6d644d !important; border-radius: 0.8rem !important; 
            padding: 0.8rem 1rem 0.8rem 2rem !important; /* ç¢ºä¿ç¸®æ’è·é›¢ */
            outline: none; width: 100%; -webkit-appearance: none;
        }
        input::placeholder { color: #B4A582; opacity: 0.5; }
        .btn-add { background-color: #B4A582; color: #FFFFFF; font-weight: bold; border-radius: 0.8rem; padding: 0.8rem 1rem; width: 100%; }
        .day-header { font-size: 1.4rem; font-weight: bold; border-bottom: 2px solid #B4A582; margin-bottom: 1rem; padding-bottom: 0.5rem; }
    </style>
</head>
<body class="pb-10">

    <header class="p-8 text-center">
        <h1 class="text-3xl font-bold tracking-wider">é«˜æ¾ 19/12â€§20/12â€§21/12</h1>
    </header>

    <div class="max-w-md mx-auto px-5">
        <section class="glass-card">
            <h2 class="font-bold mb-4">ğŸ‘¤ æˆå“¡è¨­å®š</h2>
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="nameA" placeholder="æˆå“¡ A å§“å" onchange="updateNames()">
                <input type="text" id="nameB" placeholder="æˆå“¡ B å§“å" onchange="updateNames()">
            </div>
        </section>

        <section class="glass-card">
            <div class="day-header">ğŸ—“ï¸ Day 1 (19/12)</div>
            <div id="list-day1"></div>
            <div class="grid grid-cols-3 gap-2 mt-4">
                <input type="time" id="time-day1" style="width: auto;">
                <input type="text" id="loc-day1" placeholder="è¼¸å…¥åœ°é»" class="col-span-2">
                <button onclick="addItem(1)" class="btn-add col-span-3">ï¼‹ æ–°å¢è¡Œç¨‹</button>
            </div>
        </section>

        <section class="glass-card">
            <h2 class="font-bold mb-4">ğŸ’° æ—…éŠåˆ†å¸³</h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="text-center p-3 bg-white rounded-2xl border border-[#B4A582]/30 shadow-sm">
                    <p class="text-xs opacity-70 mb-1">å·²æ”¯ä»˜ï¼š<span class="display-name-a">A</span></p>
                    <p id="totalA" class="text-2xl font-bold">Â¥0</p>
                </div>
                <div class="text-center p-3 bg-white rounded-2xl border border-[#B4A582]/30 shadow-sm">
                    <p class="text-xs opacity-70 mb-1">å·²æ”¯ä»˜ï¼š<span class="display-name-b">B</span></p>
                    <p id="totalB" class="text-2xl font-bold">Â¥0</p>
                </div>
            </div>
            
            <div class="space-y-3">
                <select id="payerSelect">
                    <option value="A">ç”± <span class="display-name-a">æˆå“¡ A</span> ä»˜æ¬¾</option>
                    <option value="B">ç”± <span class="display-name-b">æˆå“¡ B</span> ä»˜æ¬¾</option>
                </select>
                <input type="text" id="expItem" placeholder="æ”¯å‡ºé …ç›® (å¦‚ï¼šä¸€é¶´éª¨ä»˜é³¥)">
                <input type="number" id="expAmount" placeholder="è¼¸å…¥é‡‘é¡">
                <button onclick="addExpense()" class="btn-add mt-2">è¨˜éŒ„æ”¯å‡º</button>
            </div>

            <div class="mt-6 pt-4 border-t border-[#B4A582]/20">
                <p class="text-xs font-bold mb-2 opacity-60">æœ€è¿‘æ”¯å‡ºç´€éŒ„ï¼š</p>
                <div id="expense-logs" class="max-h-40 overflow-y-auto"></div>
            </div>
        </section>
    </div>
</body>
</html>