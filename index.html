<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±äº¬â‡‹é«˜æ¾ | Mei & Wing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Roboto+Condensed:wght@700&family=Varela+Round&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FFFFFF; color: #333; overflow-x: hidden; }
        .yuan-font { font-family: 'Varela Round', 'Noto Sans TC', sans-serif; font-style: italic; font-weight: 900; }
        .din-font { font-family: 'Roboto Condensed', sans-serif; letter-spacing: -0.02em; }
        .tab-box { border: 1.5px solid #E8E2D5; padding: 10px 5px; transition: all 0.3s; width: 85%; margin: 0 auto; border-radius: 12px; }
        .active-tab .tab-box { border-color: #B4A582; background-color: #fdfbf7; }
        .active-tab { color: #B4A582 !important; }
        .timeline-container { position: relative; }
        .timeline-container::before { content: ''; position: absolute; left: 16px; top: 10px; bottom: 10px; width: 2px; background: #B4A582; opacity: 0.15; }
        
        /* è§£æ±ºé‡ç–Šï¼šç¢ºä¿èƒŒæ™¯ä¸é€æ˜ä¸”å±¤ç´šæœ€é«˜ */
        .overlay { position: fixed; inset: 0; background: #FFFFFF; z-index: 2000; overflow-y: auto; height: 100vh; width: 100vw; }
        .input-minimal input { border: none !important; border-bottom: 1px solid #F0EBE0 !important; background: transparent !important; padding: 0.6rem 0 !important; font-size: 12px !important; outline: none; width: 100%; }
        .quick-btn { border: 1px solid #B4A582; color: #B4A582; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; transition: all 0.2s; }
        .quick-btn:active { background: #B4A582; color: white; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBA6MsDbbg_mqeLzliJfN1DyrFmUd_CrKo",
            authDomain: "takamatsu12191221.firebaseapp.com",
            databaseURL: "https://takamatsu12191221-default-rtdb.firebaseio.com",
            projectId: "takamatsu12191221",
            storageBucket: "takamatsu12191221.firebasestorage.app",
            messagingSenderId: "701975778652",
            appId: "1:701975778652:web:030547b85044b2cad75d99"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tripRef = ref(db, 'takamatsu_trip');

        let currentEditId = { 1: null, 2: null, 3: null };
        let currentExpenseEditId = null;
        let currentTransEditId = null;

        onValue(tripRef, (snapshot) => {
            const data = snapshot.val() || {};
            renderUI(data);
            renderTransport(data.transport || {});
        });

        function renderUI(data) {
            // å‚™å¿˜éŒ„
            for(let d=1; d<=3; d++) {
                document.getElementById(`day-note-${d}`).value = data.day_notes?.[`day${d}`] || "";
            }
            // è¡Œç¨‹æ¸²æŸ“
            for (let day = 1; day <= 3; day++) {
                const listEl = document.getElementById(`timeline-day${day}`);
                const dayData = data.itinerary ? data.itinerary[`day${day}`] : null;
                listEl.innerHTML = "";
                if (dayData) {
                    const items = Object.entries(dayData).map(([id, val]) => ({ id, ...val }));
                    items.sort((a, b) => a.time.localeCompare(b.time));
                    items.forEach(item => {
                        const hasUrl = item.url && item.url.startsWith('http');
                        listEl.innerHTML += `
                            <div class="relative pl-12 mb-8 text-xs">
                                <div class="absolute left-[9px] top-2 w-4 h-4 rounded-full bg-[#B4A582] border-4 border-white shadow-sm z-10"></div>
                                <div class="bg-[#fdfbf7] border border-[#B4A582]/15 rounded-[1.5rem] p-5 shadow-sm">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-[#B4A582] font-black tracking-widest din-font text-xs">${item.time}</span>
                                        <div class="flex gap-4 text-gray-300">
                                            <button onclick='window.prepareEdit(${day}, "${item.id}", ${JSON.stringify(item)})'><i class="fa-solid fa-pen"></i></button>
                                            <button onclick="window.deleteItem(${day}, '${item.id}')">âœ•</button>
                                        </div>
                                    </div>
                                    <h3 class="font-bold text-gray-800 text-lg mb-1">${item.loc}</h3>
                                    <div class="space-y-1 text-gray-500 mb-4">
                                        <p class="flex items-center text-[#B4A582] font-medium"><i class="fa-solid fa-train-subway w-5 text-sm"></i> ${item.trans || '-'}</p>
                                        <p class="flex items-start opacity-80"><i class="fa-solid fa-quote-left w-5 mt-1 opacity-30 text-[10px]"></i> <span class="flex-1">${item.note || '-'}</span></p>
                                    </div>
                                    <div class="flex gap-2">
                                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.loc)}" target="_blank" class="flex-1 text-center py-2 bg-white border border-[#B4A582]/30 rounded-xl text-[#B4A582] font-bold shadow-sm">ğŸ“ å°èˆª</a>
                                        ${hasUrl ? `<a href="${item.url}" target="_blank" class="flex-1 text-center py-2 bg-[#B4A582] rounded-xl text-white font-bold shadow-md">ğŸ”— é€£çµ</a>` : ''}
                                    </div>
                                </div>
                            </div>`;
                    });
                }
            }

            // è²»ç”¨æ¸²æŸ“ (åŒå‰ï¼Œç•¥ä½œå­—é«”èª¿æ•´)
            const logs = data.expense_logs ? Object.entries(data.expense_logs) : [];
            const logEl = document.getElementById('expense-logs');
            logEl.innerHTML = "";
            logs.reverse().forEach(([id, log]) => {
                logEl.innerHTML += `<div class="flex justify-between items-center py-4 border-b border-gray-50"><div class="text-[13px]"><span class="text-xs bg-[#B4A582]/10 text-[#B4A582] px-2 py-0.5 rounded-md mr-2 font-bold">${log.cat}</span><span class="text-gray-700 font-medium">${log.item}</span><p class="text-[10px] text-gray-300 mt-0.5">${log.payer} æ”¯ä»˜</p></div><div class="flex items-center gap-4"><span class="font-bold text-[#B4A582] text-base din-font">Â¥${log.amount.toLocaleString()}</span><button onclick='window.prepareEditExpense("${id}", ${JSON.stringify(log)})' class="text-gray-200"><i class="fa-solid fa-pen text-[10px]"></i></button></div></div>`;
            });
            // è²»ç”¨çŸ©é™£è¨ˆç®—èˆ‡æ¸²æŸ“
            const categories = ['äº¤é€š', 'é£²é£Ÿ', 'è³¼ç‰©', 'ä½å®¿', 'å…¶ä»–'];
            const matrix = categories.reduce((acc, cat) => { acc[cat] = { Mei: 0, Wing: 0 }; return acc; }, {});
            logs.forEach(([id, log]) => { if(matrix[log.cat]) matrix[log.cat][log.payer] += log.amount; });
            let matrixHtml = `<table class="w-full text-center border-collapse"><thead><tr class="text-gray-400 border-b border-gray-100"><th class="py-2 text-left pl-2 font-normal text-xs">é¡åˆ¥</th><th class="py-2 text-xs">Mei</th><th class="py-2 text-xs">Wing</th></tr></thead><tbody class="text-gray-600">`;
            categories.forEach(cat => { matrixHtml += `<tr class="border-b border-gray-50/50"><td class="py-4 font-bold text-left pl-2 text-sm">${cat}</td><td class="py-4 din-font text-sm">Â¥${matrix[cat].Mei.toLocaleString()}</td><td class="py-4 din-font text-sm">Â¥${matrix[cat].Wing.toLocaleString()}</td></tr>`; });
            const totalMei = Object.values(matrix).reduce((a, b) => a + b.Mei, 0);
            const totalWing = Object.values(matrix).reduce((a, b) => a + b.Wing, 0);
            matrixHtml += `<tr class="text-[#B4A582] font-black border-t-2 border-dashed border-[#B4A582]/30"><td class="py-6 text-left pl-2 text-base font-bold">ç¸½è¨ˆ</td><td class="py-6 text-lg din-font">Â¥${totalMei.toLocaleString()}</td><td class="py-6 text-lg din-font">Â¥${totalWing.toLocaleString()}</td></tr></tbody></table>`;
            document.getElementById('expense-matrix').innerHTML = matrixHtml;
        }

        // äº¤é€šç®¡ç†æ¸²æŸ“
        function renderTransport(transData) {
            const list = document.getElementById('trans-list');
            list.innerHTML = "";
            Object.entries(transData).forEach(([id, t]) => {
                const hasUrl = t.url && t.url.startsWith('http');
                list.innerHTML += `
                <div class="bg-[#fdfbf7] p-5 rounded-[2rem] border border-[#B4A582]/15 mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-3 text-[#B4A582]">
                            <i class="fa-solid fa-route text-xl"></i>
                            <h3 class="font-black text-lg">${t.name}</h3>
                        </div>
                        <div class="flex gap-4 text-gray-300">
                             <button onclick='window.prepareEditTrans("${id}", ${JSON.stringify(t)})' class="text-xs"><i class="fa-solid fa-pen"></i></button>
                             <button onclick="window.deleteTrans('${id}')" class="text-xs">âœ•</button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mb-4 px-2 leading-relaxed">${t.note || 'ç„¡å‚™è¨»'}</p>
                    ${hasUrl ? `<a href="${t.url}" target="_blank" class="block w-full text-center py-3 bg-[#B4A582] rounded-xl text-white font-bold text-xs shadow-md">ğŸ”— é–‹å•Ÿè·¯ç·šåœ–/é€£çµ</a>` : ''}
                </div>`;
            });
        }

        // äº¤é€šå·¥å…· Window Functions
        window.setQuickName = (name) => { document.getElementById('new-trans-name').value = name; };
        window.saveTrans = () => {
            const name = document.getElementById('new-trans-name').value;
            const note = document.getElementById('new-trans-note').value;
            const url = document.getElementById('new-trans-url').value;
            if(!name) return;
            if(currentTransEditId) {
                update(ref(db, `takamatsu_trip/transport/${currentTransEditId}`), { name, note, url });
                currentTransEditId = null;
                document.getElementById('btn-save-trans').innerText = "ç¢ºèªå¢åŠ ";
            } else {
                push(ref(db, 'takamatsu_trip/transport'), { name, note, url });
            }
            ['new-trans-name','new-trans-note','new-trans-url'].forEach(id => document.getElementById(id).value = "");
        };
        window.prepareEditTrans = (id, t) => {
            currentTransEditId = id;
            document.getElementById('new-trans-name').value = t.name;
            document.getElementById('new-trans-note').value = t.note;
            document.getElementById('new-trans-url').value = t.url;
            document.getElementById('btn-save-trans').innerText = "ğŸ’¾ å„²å­˜ä¿®æ”¹";
        };
        window.deleteTrans = (id) => { if(confirm("ç¢ºå®šåˆªé™¤æ­¤äº¤é€šï¼Ÿ")) remove(ref(db, `takamatsu_trip/transport/${id}`)); };

        // å…¶é¤˜é€šç”¨çš„ Window Functions
        window.toggleOverlay = (id, show) => {
            const el = document.getElementById(id);
            if(show) { el.classList.remove('hidden'); document.body.style.overflow = 'hidden'; } 
            else { el.classList.add('hidden'); document.body.style.overflow = 'auto'; }
        };
        window.saveDayNote = (day) => { update(ref(db, `takamatsu_trip/day_notes`), { [`day${day}`]: document.getElementById(`day-note-${day}`).value }); };
        window.addItem = (day) => {
            const vals = ['time','loc','trans','note','url'].reduce((acc, k) => { acc[k] = document.getElementById(`${k}-day${day}`).value; return acc; }, {});
            if(!vals.time || !vals.loc) return;
            if (currentEditId[day]) { set(ref(db, `takamatsu_trip/itinerary/day${day}/${currentEditId[day]}`), vals); currentEditId[day] = null; document.getElementById(`btn-save-day${day}`).innerText = "ï¼‹ è¨˜éŒ„è¡Œç¨‹"; } 
            else { push(ref(db, `takamatsu_trip/itinerary/day${day}`), vals); }
            ['time','loc','trans','note','url'].forEach(k => document.getElementById(`${k}-day${day}`).value = "");
        };
        window.prepareEdit = (day, id, item) => {
            currentEditId[day] = id;
            ['time','loc','trans','note','url'].forEach(k => document.getElementById(`${k}-day${day}`).value = item[k] || "");
            document.getElementById(`btn-save-day${day}`).innerText = "ğŸ’¾ å„²å­˜ä¿®æ”¹";
        };
        window.deleteItem = (day, id) => { if(confirm("åˆªé™¤è¡Œç¨‹ï¼Ÿ")) remove(ref(db, `takamatsu_trip/itinerary/day${day}/${id}`)); };
        window.addExpense = () => {
            const payer = document.getElementById('payerSelect').value, cat = document.getElementById('catSelect').value, item = document.getElementById('expItem').value || "æ”¯å‡º", amount = parseFloat(document.getElementById('expAmount').value);
            if(isNaN(amount)) return;
            if(currentExpenseEditId) { update(ref(db, `takamatsu_trip/expense_logs/${currentExpenseEditId}`), { payer, cat, item, amount }); currentExpenseEditId = null; document.getElementById('btn-save-expense').innerText = "ç¢ºèªè¨˜éŒ„"; }
            else { push(ref(db, 'takamatsu_trip/expense_logs'), { payer, cat, item, amount }); }
            document.getElementById('expItem').value = ""; document.getElementById('expAmount').value = "";
        };
        window.prepareEditExpense = (id, log) => {
            currentExpenseEditId = id;
            document.getElementById('payerSelect').value = log.payer; document.getElementById('catSelect').value = log.cat; document.getElementById('expItem').value = log.item; document.getElementById('expAmount').value = log.amount;
            document.getElementById('btn-save-expense').innerText = "ğŸ’¾ å„²å­˜ä¿®æ”¹";
        };
        window.switchTab = (day) => {
            document.querySelectorAll('.day-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`day${day}-panel`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active-tab'));
            event.currentTarget.classList.add('active-tab');
        };
    </script>
</head>
<body class="max-w-md mx-auto">

    <header class="flex justify-between items-center p-8">
        <div class="flex items-center gap-3">
            <div>
                <h1 class="text-3xl yuan-font text-[#B4A582] tracking-tighter leading-none">æ±äº¬â‡‹é«˜æ¾</h1>
                <p class="font-bold text-xs text-[#B4A582]/60 mt-1 uppercase tracking-widest din-font">Tokyo to Takamatsu</p>
            </div>
            <img src="https://japaclip.com/files/udon-kitsune.png" alt="Udon" class="w-12 h-12 object-contain">
        </div>
        <div class="flex gap-4">
            <button onclick="toggleOverlay('trans-overlay', true)" class="text-2xl text-[#B4A582]"><i class="fa-solid fa-map-location-dot"></i></button>
            <button onclick="toggleOverlay('expense-overlay', true)" class="text-2xl text-[#B4A582]"><i class="fa-solid fa-receipt"></i></button>
        </div>
    </header>

    <div class="flex mb-8 w-full sticky top-0 bg-white z-20 pt-2 pb-4">
        <button onclick="switchTab(1)" class="tab-btn active-tab flex-1 text-center"><div class="tab-box"><span class="day-title font-bold">Day 1</span><span class="day-date din-font">12/19 (Fri)</span></div></button>
        <button onclick="switchTab(2)" class="tab-btn flex-1 text-center text-gray-400"><div class="tab-box"><span class="day-title font-bold">Day 2</span><span class="day-date din-font">12/20 (Sat)</span></div></button>
        <button onclick="switchTab(3)" class="tab-btn flex-1 text-center text-gray-400"><div class="tab-box"><span class="day-title font-bold">Day 3</span><span class="day-date din-font">12/21 (Sun)</span></div></button>
    </div>

    <main class="px-6 pb-40">
        <script>
            const dayMeta = [
                { id: 1, w: '13', l: '9', r: '0', icon: 'fa-sun' },
                { id: 2, w: '12', l: '8', r: '20', icon: 'fa-cloud-sun' },
                { id: 3, w: '11', l: '7', r: '10', icon: 'fa-sun' }
            ];
            dayMeta.forEach(d => {
                document.write(`
                <div id="day${d.id}-panel" class="day-content ${d.id===1?'':'hidden'}">
                    <div class="flex justify-between items-center mb-6 px-2">
                        <input type="text" id="day-note-${d.id}" onchange="saveDayNote(${d.id})" placeholder="âœï¸ ä»Šæ—¥å‚™å¿˜..." class="text-sm text-[#B4A582] bg-transparent border-none outline-none font-bold placeholder:opacity-30 w-1/2">
                        <div class="flex items-center gap-2 text-[#B4A582]">
                            <i class="fa-solid ${d.icon} text-2xl"></i>
                            <div class="text-left leading-tight din-font">
                                <p class="text-lg font-black">${d.w}Â°C</p>
                                <p class="text-[10px] font-bold opacity-70">ä½æº« ${d.l}Â°C / é™é›¨ ${d.r}%</p>
                            </div>
                        </div>
                    </div>
                    <div id="timeline-day${d.id}" class="timeline-container"></div>
                    <div class="mt-16 pt-10 border-t-2 border-dashed border-[#B4A582]/30 input-minimal">
                        <div class="grid grid-cols-2 gap-6 mb-4"><input type="time" id="time-day${d.id}" class="din-font"><input type="text" id="loc-day${d.id}" placeholder="åœ°é»"></div>
                        <input type="text" id="trans-day${d.id}" placeholder="äº¤é€š" class="mb-4">
                        <input type="text" id="note-day${d.id}" placeholder="å‚™è¨»" class="mb-4">
                        <input type="url" id="url-day${d.id}" placeholder="ç¶²å€ (https://...)" class="mb-8">
                        <button id="btn-save-day${d.id}" onclick="addItem(${d.id})" class="w-full bg-[#B4A582] text-white py-4 rounded-2xl font-bold text-xs shadow-md">ï¼‹ è¨˜éŒ„è¡Œç¨‹</button>
                    </div>
                </div>`);
            });
        </script>
    </main>

    <div id="trans-overlay" class="overlay hidden p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black text-[#B4A582]">ğŸ“ äº¤é€šå·¥å…·</h2>
            <button onclick="toggleOverlay('trans-overlay', false)" class="text-3xl text-gray-200">âœ•</button>
        </div>
        
        <div class="bg-[#B4A582]/5 p-5 rounded-[2rem] border border-[#B4A582]/20 mb-10 input-minimal">
            <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                <button onclick="setQuickName('JRç·š')" class="quick-btn shrink-0">JRç·š</button>
                <button onclick="setQuickName('ã¨ã“ã¨ã§ã‚“')" class="quick-btn shrink-0">ç´é›»</button>
                <button onclick="setQuickName('èˆ¹')" class="quick-btn shrink-0">èˆ¹</button>
                <button onclick="setQuickName('å·´å£«')" class="quick-btn shrink-0">å·´å£«</button>
            </div>
            <input type="text" id="new-trans-name" placeholder="åç¨±">
            <input type="text" id="new-trans-note" placeholder="å‚™è¨»">
            <input type="url" id="new-trans-url" placeholder="ç¶²å€ (https://...)">
            <button id="btn-save-trans" onclick="saveTrans()" class="w-full bg-[#B4A582] text-white py-3 rounded-xl font-bold text-xs mt-4">ç¢ºèªå¢åŠ </button>
        </div>

        <div id="trans-list"></div>
        <div class="h-20"></div>
    </div>

    <div id="expense-overlay" class="overlay hidden p-8">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-2xl font-black text-[#B4A582]">ğŸ’° è²»ç”¨</h2>
            <button onclick="toggleOverlay('expense-overlay', false)" class="text-3xl text-gray-200">âœ•</button>
        </div>
        <div id="expense-matrix" class="mb-10 p-6 bg-[#fdfbf7] rounded-[2rem] border border-[#B4A582]/10 shadow-inner"></div>
        <div class="space-y-4 mb-12">
            <div class="grid grid-cols-2 gap-3">
                <select id="payerSelect" class="bg-gray-50 p-4 rounded-xl text-sm outline-none font-bold text-[#B4A582]"><option value="Mei">Mei</option><option value="Wing">Wing</option></select>
                <select id="catSelect" class="bg-gray-50 p-4 rounded-xl text-sm outline-none"><option value="äº¤é€š">ğŸš— äº¤é€š</option><option value="é£²é£Ÿ">ğŸœ é£²é£Ÿ</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="ä½å®¿">ğŸ¨ ä½å®¿</option><option value="å…¶ä»–">âœ¨ å…¶ä»–</option></select>
            </div>
            <input type="text" id="expItem" placeholder="æ”¯å‡ºé …ç›®" class="w-full bg-gray-50 p-4 rounded-xl text-sm outline-none"><input type="number" id="expAmount" placeholder="é‡‘é¡ (JPY)" class="w-full bg-gray-50 p-4 rounded-xl text-sm outline-none font-bold din-font">
            <button id="btn-save-expense" onclick="addExpense()" class="w-full bg-[#B4A582] text-white py-4 rounded-xl font-bold">ç¢ºèªè¨˜éŒ„</button>
        </div>
        <div id="expense-logs"></div>
    </div>

</body>
</html>
