<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±äº¬â‡‹é«˜æ¾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBA6MsDbbg_mqeLzliJfN1DyrFmUd_CrKo",
            authDomain: "takamatsu12191221.firebaseapp.com",
            databaseURL: "https://takamatsu12191221-default-rtdb.firebaseio.com",
            projectId: "takamatsu12191221",
            storageBucket: "takamatsu12191221.firebasestorage.app",
            messagingSenderId: "701975778652",
            appId: "1:701975778652:web:030547b85044b2cad75d99",
            measurementId: "G-ZKWE4934GZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tripRef = ref(db, 'takamatsu_trip');

        let currentEditId = { 1: null, 2: null, 3: null };

        onValue(tripRef, (snapshot) => {
            const data = snapshot.val() || { names: {a: "æˆå“¡ A", b: "æˆå“¡ B"}, itinerary: {}, expenses: {a: 0, b: 0}, expense_logs: {} };
            renderUI(data);
        });

        function renderUI(data) {
            document.querySelectorAll('.display-name-a').forEach(el => el.innerText = data.names?.a || "æˆå“¡ A");
            document.querySelectorAll('.display-name-b').forEach(el => el.innerText = data.names?.b || "æˆå“¡ B");
            document.getElementById('nameA').value = data.names?.a || "";
            document.getElementById('nameB').value = data.names?.b || "";
            document.getElementById('totalA').innerText = `Â¥${(data.expenses?.a || 0).toLocaleString()}`;
            document.getElementById('totalB').innerText = `Â¥${(data.expenses?.b || 0).toLocaleString()}`;

            for (let day = 1; day <= 3; day++) {
                const listEl = document.getElementById(`timeline-day${day}`);
                const dayData = data.itinerary ? data.itinerary[`day${day}`] : null;
                listEl.innerHTML = "";
                if (dayData) {
                    const items = Object.entries(dayData).map(([id, val]) => ({ id, ...val }));
                    items.sort((a, b) => a.time.localeCompare(b.time));
                    items.forEach(item => {
                        const hasUrl = item.url && item.url.startsWith('http');
                        listEl.innerHTML += `
                            <div class="bg-[#fdfbf7] border border-[#B4A582]/20 rounded-3xl p-5 mb-5 shadow-sm">
                                <div class="flex justify-between items-start mb-3">
                                    <span class="text-[#B4A582] font-bold text-sm bg-white px-4 py-1 rounded-full border border-[#B4A582]/30">${item.time}</span>
                                    <div class="flex gap-4 text-gray-400">
                                        <button onclick='window.prepareEdit(${day}, "${item.id}", ${JSON.stringify(item)})' class="hover:text-[#B4A582]"><i class="fa-solid fa-pen-to-square"></i></button>
                                        <button onclick="window.deleteItem(${day}, '${item.id}')" class="hover:text-red-400">âœ•</button>
                                    </div>
                                </div>
                                <h3 class="font-bold text-gray-800 text-xl mb-2">${item.loc}</h3>
                                <div class="space-y-1 text-sm">
                                    <p class="text-[#B4A582] flex items-center"><i class="fa-solid fa-train-subway w-6"></i> ${item.trans || '-'}</p>
                                    <p class="text-gray-500 flex items-start"><i class="fa-solid fa-align-left w-6 mt-1"></i> <span class="flex-1">${item.note || '-'}</span></p>
                                </div>
                                <div class="flex gap-2 mt-4 pt-3 border-t border-dashed border-[#B4A582]/20">
                                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.loc)}" target="_blank" class="flex-1 text-center py-2 bg-white border border-[#B4A582]/30 rounded-xl text-xs text-[#B4A582] font-bold">ğŸ“ å°èˆª</a>
                                    ${hasUrl ? `<a href="${item.url}" target="_blank" class="flex-1 text-center py-2 bg-[#B4A582] rounded-xl text-xs text-white font-bold">ğŸ”— ç¶²å€</a>` : ''}
                                </div>
                            </div>`;
                    });
                }
            }

            // æ¸²æŸ“è²»ç”¨ç´€éŒ„
            const logEl = document.getElementById('expense-logs');
            logEl.innerHTML = "";
            if (data.expense_logs) {
                Object.entries(data.expense_logs).reverse().slice(0, 15).forEach(([id, log]) => {
                    logEl.innerHTML += `
                        <div class="flex justify-between items-center py-4 border-b border-gray-50">
                            <div><p class="text-gray-800 text-sm font-medium">${log.item}</p><p class="text-[10px] text-gray-400">${log.payer === 'A' ? (data.names?.a || 'A') : (data.names?.b || 'B')} æ”¯ä»˜</p></div>
                            <div class="flex items-center gap-4"><span class="font-bold text-[#B4A582] text-lg">Â¥${log.amount.toLocaleString()}</span>
                            <button onclick="window.deleteExpense('${id}', '${log.payer}', ${log.amount})" class="text-gray-200">âœ•</button></div>
                        </div>`;
                });
            }
        }

        window.switchTab = (day) => {
            document.querySelectorAll('.day-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`day${day}-panel`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active-tab'));
            event.currentTarget.classList.add('active-tab');
        };

        window.toggleOverlay = (id, show) => { document.getElementById(id).style.display = show ? 'block' : 'none'; };

        window.prepareEdit = (day, id, item) => {
            currentEditId[day] = id;
            document.getElementById(`time-day${day}`).value = item.time;
            document.getElementById(`loc-day${day}`).value = item.loc;
            document.getElementById(`trans-day${day}`).value = item.trans || "";
            document.getElementById(`note-day${day}`).value = item.note || "";
            document.getElementById(`url-day${day}`).value = item.url || "";
            document.getElementById(`btn-save-day${day}`).innerText = "ğŸ’¾ å„²å­˜ä¿®æ”¹";
            document.getElementById(`btn-save-day${day}`).classList.replace('bg-[#B4A582]', 'bg-orange-400');
            document.getElementById(`loc-day${day}`).focus();
        };

        window.addItem = (day) => {
            const time = document.getElementById(`time-day${day}`).value;
            const loc = document.getElementById(`loc-day${day}`).value;
            const trans = document.getElementById(`trans-day${day}`).value;
            const note = document.getElementById(`note-day${day}`).value;
            const url = document.getElementById(`url-day${day}`).value;
            if(!time || !loc) return;

            if (currentEditId[day]) {
                set(ref(db, `takamatsu_trip/itinerary/day${day}/${currentEditId[day]}`), { time, loc, trans, note, url });
                currentEditId[day] = null;
                document.getElementById(`btn-save-day${day}`).innerText = "ï¼‹ æ–°å¢è¡Œç¨‹";
                document.getElementById(`btn-save-day${day}`).classList.replace('bg-orange-400', 'bg-[#B4A582]');
            } else {
                push(ref(db, `takamatsu_trip/itinerary/day${day}`), { time, loc, trans, note, url });
            }

            document.getElementById(`time-day${day}`).value = "";
            document.getElementById(`loc-day${day}`).value = "";
            document.getElementById(`trans-day${day}`).value = "";
            document.getElementById(`note-day${day}`).value = "";
            document.getElementById(`url-day${day}`).value = "";
        };

        window.deleteItem = (day, id) => { if(confirm("ç¢ºå®šåˆªé™¤è¡Œç¨‹ï¼Ÿ")) remove(ref(db, `takamatsu_trip/itinerary/day${day}/${id}`)); };

        window.addExpense = () => {
            const payer = document.getElementById('payerSelect').value;
            const item = document.getElementById('expItem').value || "æ”¯å‡º";
            const amount = parseFloat(document.getElementById('expAmount').value);
            if(isNaN(amount)) return;
            const totalPath = `takamatsu_trip/expenses/${payer.toLowerCase()}`;
            onValue(ref(db, totalPath), (s) => set(ref(db, totalPath), (s.val()||0) + amount), {onlyOnce: true});
            push(ref(db, 'takamatsu_trip/expense_logs'), { payer, item, amount });
            document.getElementById('expItem').value = ""; document.getElementById('expAmount').value = "";
        };

        window.updateNames = () => {
            set(ref(db, 'takamatsu_trip/names'), { a: document.getElementById('nameA').value, b: document.getElementById('nameB').value });
        };

        window.deleteExpense = (id, payer, amount) => {
            if(confirm("åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) {
                remove(ref(db, `takamatsu_trip/expense_logs/${id}`));
                const path = `takamatsu_trip/expenses/${payer.toLowerCase()}`;
                onValue(ref(db, path), (s) => set(ref(db, path), Math.max(0, (s.val()||0) - amount)), {onlyOnce: true});
            }
        };
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FFFFFF; color: #333; }
        .font-cursive { font-family: 'Dancing Script', cursive; }
        .active-tab { color: #B4A582 !important; border-bottom: 3px solid #B4A582 !important; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: none; overflow-y: auto; }
        input, select {
            background-color: #FDFBF7 !important; border: 1px solid #F0EBE0 !important;
            padding: 0.8rem 1rem 0.8rem 2rem !important; border-radius: 1rem !important; outline: none; width: 100%; font-size: 0.95rem;
        }
        .weather-card { display: flex; align-items: center; justify-content: flex-end; gap: 15px; color: #B4A582; margin-bottom: 20px; }
        .weather-temp { font-size: 1.4rem; font-weight: 700; line-height: 1; }
        .weather-desc { font-size: 0.75rem; opacity: 0.8; text-align: right; }
    </style>
</head>
<body class="max-w-md mx-auto">

    <header class="flex justify-between items-start p-7">
        <div>
            <h1 class="text-3xl font-black text-[#B4A582] tracking-tighter leading-none">æ±äº¬â‡‹é«˜æ¾</h1>
            <p class="font-cursive text-xl text-[#B4A582] mt-2">Tokyo to Takamatsu</p>
        </div>
        <div class="flex gap-6 text-2xl text-[#B4A582] pt-2">
            <button onclick="toggleOverlay('expense-overlay', true)"><i class="fa-solid fa-receipt"></i></button>
        </div>
    </header>

    <div class="flex border-b border-gray-100 mb-8 w-full px-2">
        <button onclick="switchTab(1)" class="tab-btn active-tab flex-1 py-4 text-center">
            <span class="block font-bold text-sm">Day 1</span>
            <span class="text-[10px] opacity-60">19/12 Fri</span>
        </button>
        <button onclick="switchTab(2)" class="tab-btn flex-1 py-4 text-center">
            <span class="block font-bold text-sm text-gray-400">Day 2</span>
            <span class="text-[10px] opacity-40">20/12 Sat</span>
        </button>
        <button onclick="switchTab(3)" class="tab-btn flex-1 py-4 text-center">
            <span class="block font-bold text-sm text-gray-400">Day 3</span>
            <span class="text-[10px] opacity-40">21/12 Sun</span>
        </button>
    </div>

    <main class="px-6 pb-48">
        <div id="day1-panel" class="day-content">
            <div class="weather-card">
                <div><p class="weather-temp">13Â°C</p><p class="weather-desc">9Â°C / 0% é™é›¨</p></div>
                <i class="fa-solid fa-sun text-4xl"></i>
            </div>
            <div id="timeline-day1"></div>
            <div class="mt-12 space-y-3 bg-[#FDFBF7] p-6 rounded-[2rem] border border-[#B4A582]/10 shadow-inner">
                <div class="grid grid-cols-2 gap-3"><input type="time" id="time-day1"><input type="text" id="loc-day1" placeholder="è¡Œç¨‹åœ°é»"></div>
                <input type="text" id="trans-day1" placeholder="äº¤é€š (ä¾‹å¦‚: âœˆï¸ NRT-TAK)">
                <input type="text" id="note-day1" placeholder="å‚™è¨»/å…§å®¹">
                <input type="url" id="url-day1" placeholder="ç›¸é—œç¶²å€ (https://...)">
                <button id="btn-save-day1" onclick="addItem(1)" class="w-full bg-[#B4A582] text-white py-4 rounded-2xl font-bold mt-2 shadow-lg active:scale-95 transition-all">ï¼‹ æ–°å¢è¡Œç¨‹</button>
            </div>
        </div>

        <div id="day2-panel" class="day-content hidden">
            <div class="weather-card">
                <div><p class="weather-temp">12Â°C</p><p class="weather-desc">8Â°C / 20% é™é›¨</p></div>
                <i class="fa-solid fa-cloud-sun text-4xl"></i>
            </div>
            <div id="timeline-day2"></div>
            <div class="mt-12 space-y-3 bg-[#FDFBF7] p-6 rounded-[2rem]">
                <div class="grid grid-cols-2 gap-3"><input type="time" id="time-day2"><input type="text" id="loc-day2" placeholder="è¡Œç¨‹åœ°é»"></div>
                <input type="text" id="trans-day2" placeholder="äº¤é€šæ–¹å¼"><input type="text" id="note-day2" placeholder="å‚™è¨»å…§å®¹"><input type="url" id="url-day2" placeholder="ç¶²å€"><button id="btn-save-day2" onclick="addItem(2)" class="w-full bg-[#B4A582] text-white py-4 rounded-2xl font-bold mt-2">ï¼‹ æ–°å¢è¡Œç¨‹</button>
            </div>
        </div>

        <div id="day3-panel" class="day-content hidden">
            <div class="weather-card">
                <div><p class="weather-temp">11Â°C</p><p class="weather-desc">7Â°C / 10% é™é›¨</p></div>
                <i class="fa-solid fa-sun text-4xl"></i>
            </div>
            <div id="timeline-day3"></div>
            <div class="mt-12 space-y-3 bg-[#FDFBF7] p-6 rounded-[2rem]">
                <div class="grid grid-cols-2 gap-3"><input type="time" id="time-day3"><input type="text" id="loc-day3" placeholder="è¡Œç¨‹åœ°é»"></div>
                <input type="text" id="trans-day3" placeholder="äº¤é€šæ–¹å¼"><input type="text" id="note-day3" placeholder="å‚™è¨»å…§å®¹"><input type="url" id="url-day3" placeholder="ç¶²å€"><button id="btn-save-day3" onclick="addItem(3)" class="w-full bg-[#B4A582] text-white py-4 rounded-2xl font-bold mt-2">ï¼‹ æ–°å¢è¡Œç¨‹</button>
            </div>
        </div>
    </main>

    <div id="expense-overlay" class="overlay p-8">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-3xl font-bold text-[#B4A582]">ğŸ’° è²»ç”¨æ¸…ç®—</h2>
            <button onclick="toggleOverlay('expense-overlay', false)" class="text-4xl text-gray-200">Ã—</button>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-8">
            <input type="text" id="nameA" placeholder="æˆå“¡ A" onchange="updateNames()"><input type="text" id="nameB" placeholder="æˆå“¡ B" onchange="updateNames()">
        </div>
        <div class="grid grid-cols-2 gap-4 mb-10">
            <div class="bg-gray-50 p-6 rounded-3xl text-center shadow-sm"><p class="text-[11px] text-gray-400 display-name-a uppercase mb-2">Payer A</p><p id="totalA" class="text-2xl font-bold text-[#B4A582]">Â¥0</p></div>
            <div class="bg-gray-50 p-6 rounded-3xl text-center shadow-sm"><p class="text-[11px] text-gray-400 display-name-b uppercase mb-2">Payer B</p><p id="totalB" class="text-2xl font-bold text-[#B4A582]">Â¥0</p></div>
        </div>
        <div class="bg-[#FDFBF7] p-6 rounded-[2rem] border border-[#B4A582]/10 space-y-4">
            <input type="text" id="expItem" placeholder="æ”¯å‡ºé …ç›® (å¦‚ï¼šä¸€é¶´éª¨ä»˜é³¥)">
            <div class="flex gap-3">
                <select id="payerSelect" class="w-1/2 font-bold"><option value="A">ç”± A æ”¯ä»˜</option><option value="B">ç”± B æ”¯ä»˜</option></select>
                <input type="number" id="expAmount" placeholder="é‡‘é¡" class="w-1/2">
            </div>
            <button onclick="addExpense()" class="w-full bg-[#B4A582] text-white py-4 rounded-2xl font-bold shadow-md">ç¢ºèªè¨˜éŒ„</button>
        </div>
        <div class="mt-12"><h3 class="text-xs font-bold text-gray-300 uppercase tracking-tighter mb-6">Expense History</h3><div id="expense-logs"></div></div>
    </div>

</body>
</html>
