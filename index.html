<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±äº¬â‡‹é«˜æ¾ | Mei & Wing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBA6MsDbbg_mqeLzliJfN1DyrFmUd_CrKo",
            authDomain: "takamatsu12191221.firebaseapp.com",
            databaseURL: "https://takamatsu12191221-default-rtdb.firebaseio.com",
            projectId: "takamatsu12191221",
            storageBucket: "takamatsu12191221.firebasestorage.app",
            messagingSenderId: "701975778652",
            appId: "1:701975778652:web:030547b85044b2cad75d99"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tripRef = ref(db, 'takamatsu_trip');

        let currentEditId = { 1: null, 2: null, 3: null };

        onValue(tripRef, (snapshot) => {
            const data = snapshot.val() || {};
            renderUI(data);
        });

        function renderUI(data) {
            // 1. æ¯æ—¥å‚™è¨»æ›´æ–°
            for(let d=1; d<=3; d++) {
                document.getElementById(`day-note-${d}`).value = data.day_notes?.[`day${d}`] || "";
            }

            // 2. è¡Œç¨‹æ¸²æŸ“ (é€£è‘—çš„æ™‚é–“è¡¨)
            for (let day = 1; day <= 3; day++) {
                const listEl = document.getElementById(`timeline-day${day}`);
                const dayData = data.itinerary ? data.itinerary[`day${day}`] : null;
                listEl.innerHTML = "";
                if (dayData) {
                    const items = Object.entries(dayData).map(([id, val]) => ({ id, ...val }));
                    items.sort((a, b) => a.time.localeCompare(b.time));
                    items.forEach((item, idx) => {
                        const hasUrl = item.url && item.url.startsWith('http');
                        listEl.innerHTML += `
                            <div class="relative pl-10 mb-8 timeline-item">
                                <div class="absolute left-[4px] top-1 w-3 h-3 rounded-full bg-[#B4A582] border-2 border-white ring-4 ring-[#B4A582]/10 z-10"></div>
                                <div class="bg-[#fdfbf7] border border-[#B4A582]/10 rounded-2xl p-4 shadow-sm relative">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-[#B4A582] font-bold text-xs uppercase tracking-widest">${item.time}</span>
                                        <div class="flex gap-3 text-gray-300">
                                            <button onclick='window.prepareEdit(${day}, "${item.id}", ${JSON.stringify(item)})' class="text-[10px] hover:text-[#B4A582]"><i class="fa-solid fa-pen"></i></button>
                                            <button onclick="window.deleteItem(${day}, '${item.id}')" class="text-[10px] hover:text-red-300">âœ•</button>
                                        </div>
                                    </div>
                                    <h3 class="font-bold text-gray-700 text-base mb-1">${item.loc}</h3>
                                    <p class="text-[11px] text-[#B4A582]/70 mb-2 font-medium"><i class="fa-solid fa-route mr-1"></i> ${item.trans || '-'}</p>
                                    <p class="text-xs text-gray-500 mb-3 leading-relaxed">${item.note || '-'}</p>
                                    <div class="flex gap-2">
                                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.loc)}" target="_blank" class="text-[10px] bg-white border border-[#B4A582]/20 px-3 py-1 rounded-md text-[#B4A582]">ğŸ“ åœ°åœ–</a>
                                        ${hasUrl ? `<a href="${item.url}" target="_blank" class="text-[10px] bg-[#B4A582] text-white px-3 py-1 rounded-md">ğŸ”— é€£çµ</a>` : ''}
                                    </div>
                                </div>
                            </div>`;
                    });
                }
            }

            // 3. è²»ç”¨è¨ˆç®—èˆ‡çµ±è¨ˆ
            const logs = data.expense_logs ? Object.entries(data.expense_logs) : [];
            const stats = { category: { 'äº¤é€š': 0, 'é£²é£Ÿ': 0, 'è³¼ç‰©': 0, 'ä½å®¿': 0, 'å…¶ä»–': 0 }, person: { 'Mei': 0, 'Wing': 0 } };
            
            const logEl = document.getElementById('expense-logs');
            logEl.innerHTML = "";
            logs.reverse().forEach(([id, log]) => {
                stats.category[log.cat] = (stats.category[log.cat] || 0) + log.amount;
                stats.person[log.payer] = (stats.person[log.payer] || 0) + log.amount;
                logEl.innerHTML += `
                    <div class="flex justify-between py-3 border-b border-gray-50 text-sm">
                        <div><span class="text-[10px] bg-gray-100 text-gray-400 px-2 py-0.5 rounded mr-2">${log.cat}</span>${log.item}</div>
                        <div class="font-bold">Â¥${log.amount.toLocaleString()} <button onclick="window.deleteExpense('${id}')" class="ml-2 text-gray-200">âœ•</button></div>
                    </div>`;
            });

            // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
            document.getElementById('totalMei').innerText = `Â¥${stats.person['Mei'].toLocaleString()}`;
            document.getElementById('totalWing').innerText = `Â¥${stats.person['Wing'].toLocaleString()}`;
            let catHtml = "";
            for(let c in stats.category) {
                catHtml += `<div class="flex justify-between text-xs py-1 text-gray-500"><span>${c}</span><span>Â¥${stats.category[c].toLocaleString()}</span></div>`;
            }
            document.getElementById('category-stats').innerHTML = catHtml;
        }

        // è¡Œå‹•èˆ‡å­˜å„²
        window.saveDayNote = (day) => {
            const note = document.getElementById(`day-note-${day}`).value;
            update(ref(db, `takamatsu_trip/day_notes`), { [`day${day}`]: note });
        };

        window.addItem = (day) => {
            const time = document.getElementById(`time-day${day}`).value;
            const loc = document.getElementById(`loc-day${day}`).value;
            const trans = document.getElementById(`trans-day${day}`).value;
            const note = document.getElementById(`note-day${day}`).value;
            const url = document.getElementById(`url-day${day}`).value;
            if(!time || !loc) return;
            if (currentEditId[day]) {
                set(ref(db, `takamatsu_trip/itinerary/day${day}/${currentEditId[day]}`), { time, loc, trans, note, url });
                currentEditId[day] = null;
                document.getElementById(`btn-save-day${day}`).innerText = "ï¼‹ è¨˜éŒ„è¡Œç¨‹";
            } else {
                push(ref(db, `takamatsu_trip/itinerary/day${day}`), { time, loc, trans, note, url });
            }
            ['time','loc','trans','note','url'].forEach(k => document.getElementById(`${k}-day${day}`).value = "");
        };

        window.deleteItem = (day, id) => { if(confirm("åˆªé™¤è¡Œç¨‹ï¼Ÿ")) remove(ref(db, `takamatsu_trip/itinerary/day${day}/${id}`)); };

        window.addExpense = () => {
            const payer = document.getElementById('payerSelect').value;
            const cat = document.getElementById('catSelect').value;
            const item = document.getElementById('expItem').value || "æ”¯å‡º";
            const amount = parseFloat(document.getElementById('expAmount').value);
            if(isNaN(amount)) return;
            push(ref(db, 'takamatsu_trip/expense_logs'), { payer, cat, item, amount });
            document.getElementById('expItem').value = ""; document.getElementById('expAmount').value = "";
        };

        window.deleteExpense = (id) => { if(confirm("åˆªé™¤æ­¤ç­†è²»ç”¨ï¼Ÿ")) remove(ref(db, `takamatsu_trip/expense_logs/${id}`)); };

        window.switchTab = (day) => {
            document.querySelectorAll('.day-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`day${day}-panel`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active-tab'));
            event.currentTarget.classList.add('active-tab');
        };

        window.toggleOverlay = (id, show) => { document.getElementById(id).style.display = show ? 'block' : 'none'; };

        window.prepareEdit = (day, id, item) => {
            currentEditId[day] = id;
            document.getElementById(`time-day${day}`).value = item.time;
            document.getElementById(`loc-day${day}`).value = item.loc;
            document.getElementById(`trans-day${day}`).value = item.trans || "";
            document.getElementById(`note-day${day}`).value = item.note || "";
            document.getElementById(`url-day${day}`).value = item.url || "";
            document.getElementById(`btn-save-day${day}`).innerText = "ğŸ’¾ å„²å­˜ä¿®æ”¹";
            document.getElementById(`loc-day${day}`).focus();
        };
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FFFFFF; color: #333; }
        .font-cursive { font-family: 'Dancing Script', cursive; }
        /* æ¨™é¡Œ Day å¤§å°å¾®èª¿ */
        .tab-btn .day-title { font-size: 1.5rem; display: block; line-height: 1; }
        .tab-btn .day-date { font-size: 0.85rem; display: block; margin-top: 5px; opacity: 0.7; }
        .active-tab { color: #B4A582 !important; border-bottom: 4px solid #B4A582 !important; }
        /* é€£è²«ç·š */
        .timeline-container { position: relative; }
        .timeline-container::before {
            content: ''; position: absolute; left: 10px; top: 10px; bottom: 10px;
            width: 1px; background: repeating-linear-gradient(to bottom, #B4A582 0, #B4A582 5px, transparent 5px, transparent 10px);
            opacity: 0.3;
        }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: none; overflow-y: auto; }
        /* æ¥µç°¡è¼¸å…¥å€ */
        .input-minimal input { 
            border: none !important; border-bottom: 1px solid #F0EBE0 !important; 
            background: transparent !important; padding: 0.5rem 0 !important; 
            font-size: 0.85rem !important; border-radius: 0 !important;
        }
        .input-minimal input:focus { border-bottom-color: #B4A582 !important; }
    </style>
</head>
<body class="max-w-md mx-auto">

    <header class="flex justify-between items-start p-8">
        <div>
            <div class="flex items-center gap-2">
                <h1 class="text-3xl font-black text-[#B4A582] tracking-tighter leading-none">æ±äº¬â‡‹é«˜æ¾</h1>
                <span class="text-3xl">ğŸœ</span>
            </div>
            <p class="font-cursive text-xl text-[#B4A582] mt-2">Tokyo to Takamatsu</p>
        </div>
        <button onclick="toggleOverlay('expense-overlay', true)" class="text-2xl text-[#B4A582] pt-2"><i class="fa-solid fa-wallet"></i></button>
    </header>

    <div class="flex border-b border-gray-100 mb-8 w-full">
        <button onclick="switchTab(1)" class="tab-btn active-tab flex-1 py-4 text-center">
            <span class="day-title font-black">Day 1</span><span class="day-date">19/12 Fri</span>
        </button>
        <button onclick="switchTab(2)" class="tab-btn flex-1 py-4 text-center">
            <span class="day-title font-black">Day 2</span><span class="day-date">20/12 Sat</span>
        </button>
        <button onclick="switchTab(3)" class="tab-btn flex-1 py-4 text-center">
            <span class="day-title font-black">Day 3</span><span class="day-date">21/12 Sun</span>
        </button>
    </div>

    <main class="px-6 pb-40">
        <script> 
            const days = [
                { id: 1, date: '19/12 Fri', weather: 'â˜€ï¸ 13Â°C / 9Â°C', icon: 'fa-sun' },
                { id: 2, date: '20/12 Sat', weather: 'â˜ï¸ 12Â°C / 8Â°C', icon: 'fa-cloud-sun' },
                { id: 3, date: '21/12 Sun', weather: 'â˜€ï¸ 11Â°C / 7Â°C', icon: 'fa-sun' }
            ];
            days.forEach(d => {
                document.write(`
                <div id="day${d.id}-panel" class="day-content ${d.id===1?'':'hidden'}">
                    <div class="flex justify-between items-center mb-6">
                        <input type="text" id="day-note-${d.id}" onchange="saveDayNote(${d.id})" placeholder="åœ¨æ­¤è¼¸å…¥ä»Šæ—¥å‚™å¿˜..." class="text-xs text-gray-400 bg-transparent border-none outline-none w-1/2">
                        <div class="flex items-center gap-3 text-[#B4A582]">
                            <div class="text-right leading-tight"><p class="text-sm font-bold">${d.weather.split(' ')[1]}</p><p class="text-[9px] opacity-60">Rain: 0%</p></div>
                            <i class="fa-solid ${d.icon} text-2xl"></i>
                        </div>
                    </div>
                    <div id="timeline-day${d.id}" class="timeline-container"></div>
                    
                    <div class="mt-12 pt-8 border-t border-dashed border-gray-200 input-minimal">
                        <div class="grid grid-cols-2 gap-4 mb-2">
                            <input type="time" id="time-day${d.id}">
                            <input type="text" id="loc-day${d.id}" placeholder="åœ°é»">
                        </div>
                        <input type="text" id="trans-day${d.id}" placeholder="äº¤é€šæ–¹å¼" class="mb-2">
                        <input type="text" id="note-day${d.id}" placeholder="å‚™è¨»å…§å®¹" class="mb-2">
                        <input type="url" id="url-day${d.id}" placeholder="ç›¸é—œé€£çµ (https://...)" class="mb-4">
                        <button id="btn-save-day${d.id}" onclick="addItem(${d.id})" class="w-full bg-[#B4A582] text-white py-3 rounded-xl font-bold text-xs shadow-sm">ï¼‹ è¨˜éŒ„è¡Œç¨‹</button>
                    </div>
                </div>
                `);
            });
        </script>
    </main>

    <div id="expense-overlay" class="overlay p-8">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold text-[#B4A582]">ğŸ’° è²»ç”¨åˆ†å¸³</h2>
            <button onclick="toggleOverlay('expense-overlay', false)" class="text-3xl text-gray-200">Ã—</button>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-50 p-4 rounded-2xl text-center shadow-sm border border-gray-100">
                <p class="text-[10px] text-gray-400 uppercase mb-1">Mei Paid</p>
                <p id="totalMei" class="text-lg font-bold text-[#B4A582]">Â¥0</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-2xl text-center shadow-sm border border-gray-100">
                <p class="text-[10px] text-gray-400 uppercase mb-1">Wing Paid</p>
                <p id="totalWing" class="text-lg font-bold text-[#B4A582]">Â¥0</p>
            </div>
        </div>

        <div id="category-stats" class="mb-8 p-4 bg-[#FDFBF7] rounded-2xl border border-[#B4A582]/10"></div>

        <div class="space-y-3 mb-10">
            <input type="text" id="expItem" placeholder="æ”¯å‡ºé …ç›® (å¦‚ï¼šä¸€é¶´éª¨ä»˜é³¥)" class="w-full border p-3 rounded-xl text-sm outline-none bg-gray-50">
            <div class="grid grid-cols-3 gap-2">
                <select id="payerSelect" class="bg-gray-50 p-3 rounded-xl text-sm border outline-none font-bold">
                    <option value="Mei">Mei</option><option value="Wing">Wing</option>
                </select>
                <select id="catSelect" class="bg-gray-50 p-3 rounded-xl text-sm border outline-none">
                    <option value="äº¤é€š">äº¤é€š</option><option value="é£²é£Ÿ">é£²é£Ÿ</option>
                    <option value="è³¼ç‰©">è³¼ç‰©</option><option value="ä½å®¿">ä½å®¿</option><option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <input type="number" id="expAmount" placeholder="é‡‘é¡" class="bg-gray-50 p-3 rounded-xl text-sm border outline-none">
            </div>
            <button onclick="addExpense()" class="w-full bg-[#B4A582] text-white py-4 rounded-xl font-bold shadow-md">ç¢ºèªè¨˜éŒ„</button>
        </div>

        <div class="mt-8"><h3 class="text-xs font-bold text-gray-300 uppercase mb-4 tracking-widest">History</h3><div id="expense-logs"></div></div>
    </div>

</body>
</html>
