<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±äº¬â‡‹é«˜æ¾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBA6MsDbbg_mqeLzliJfN1DyrFmUd_CrKo",
            authDomain: "takamatsu12191221.firebaseapp.com",
            databaseURL: "https://takamatsu12191221-default-rtdb.firebaseio.com",
            projectId: "takamatsu12191221",
            storageBucket: "takamatsu12191221.firebasestorage.app",
            messagingSenderId: "701975778652",
            appId: "1:701975778652:web:030547b85044b2cad75d99",
            measurementId: "G-ZKWE4934GZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tripRef = ref(db, 'takamatsu_trip');

        onValue(tripRef, (snapshot) => {
            const data = snapshot.val() || { names: {a: "æˆå“¡ A", b: "æˆå“¡ B"}, itinerary: {}, expenses: {a: 0, b: 0}, expense_logs: {} };
            renderUI(data);
        });

        function renderUI(data) {
            document.querySelectorAll('.display-name-a').forEach(el => el.innerText = data.names?.a || "æˆå“¡ A");
            document.querySelectorAll('.display-name-b').forEach(el => el.innerText = data.names?.b || "æˆå“¡ B");
            document.getElementById('nameA').value = data.names?.a || "";
            document.getElementById('nameB').value = data.names?.b || "";
            document.getElementById('totalA').innerText = `Â¥${(data.expenses?.a || 0).toLocaleString()}`;
            document.getElementById('totalB').innerText = `Â¥${(data.expenses?.b || 0).toLocaleString()}`;

            for (let day = 1; day <= 3; day++) {
                const listEl = document.getElementById(`timeline-day${day}`);
                const dayData = data.itinerary ? data.itinerary[`day${day}`] : null;
                listEl.innerHTML = "";
                if (dayData) {
                    const items = Object.entries(dayData).map(([id, val]) => ({ id, ...val }));
                    items.sort((a, b) => a.time.localeCompare(b.time));
                    items.forEach(item => {
                        listEl.innerHTML += `
                            <div class="bg-[#fdfbf7] border border-[#B4A582]/20 rounded-2xl p-4 mb-4 shadow-sm relative">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-[#B4A582] font-bold text-sm bg-white px-3 py-1 rounded-full border border-[#B4A582]/20">${item.time}</span>
                                    <div class="flex gap-3">
                                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.loc)}" target="_blank" class="text-[#B4A582] opacity-60"><i class="fa-solid fa-location-dot"></i></a>
                                        <button onclick="window.deleteItem(${day}, '${item.id}')" class="text-gray-300">âœ•</button>
                                    </div>
                                </div>
                                <h3 class="font-bold text-gray-800 text-lg mb-1 ml-1">${item.loc}</h3>
                                <div class="text-xs text-[#B4A582] flex items-center mb-2 ml-1">
                                    <i class="fa-solid fa-train-subway mr-2"></i> ${item.trans || 'æœªè¨­å®šäº¤é€š'}
                                </div>
                                <p class="text-sm text-gray-500 leading-relaxed border-t border-dashed border-[#B4A582]/20 pt-2 mt-2 ml-1">${item.note || '-'}</p>
                            </div>`;
                    });
                }
            }

            const logEl = document.getElementById('expense-logs');
            logEl.innerHTML = "";
            if (data.expense_logs) {
                Object.entries(data.expense_logs).reverse().slice(0, 20).forEach(([id, log]) => {
                    logEl.innerHTML += `
                        <div class="flex justify-between items-center py-3 border-b border-gray-50">
                            <div><p class="text-gray-800 text-sm">${log.item}</p>
                            <p class="text-[10px] text-gray-400">${log.payer === 'A' ? (data.names?.a || 'A') : (data.names?.b || 'B')} æ”¯ä»˜</p></div>
                            <div class="flex items-center gap-3"><span class="font-bold text-[#B4A582]">Â¥${log.amount.toLocaleString()}</span>
                            <button onclick="window.deleteExpense('${id}', '${log.payer}', ${log.amount})" class="text-gray-300">âœ•</button></div>
                        </div>`;
                });
            }
        }

        window.switchTab = (day) => {
            document.querySelectorAll('.day-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`day${day}-panel`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active-tab'));
            event.currentTarget.classList.add('active-tab');
        };

        window.toggleOverlay = (id, show) => { document.getElementById(id).style.display = show ? 'block' : 'none'; };

        window.addItem = (day) => {
            const time = document.getElementById(`time-day${day}`).value;
            const loc = document.getElementById(`loc-day${day}`).value;
            const trans = document.getElementById(`trans-day${day}`).value;
            const note = document.getElementById(`note-day${day}`).value;
            if(!time || !loc) return;
            push(ref(db, `takamatsu_trip/itinerary/day${day}`), { time, loc, trans, note });
            document.getElementById(`loc-day${day}`).value = "";
            document.getElementById(`trans-day${day}`).value = "";
            document.getElementById(`note-day${day}`).value = "";
        };

        window.deleteItem = (day, id) => { remove(ref(db, `takamatsu_trip/itinerary/day${day}/${id}`)); };

        window.addExpense = () => {
            const payer = document.getElementById('payerSelect').value;
            const item = document.getElementById('expItem').value || "æ”¯å‡º";
            const amount = parseFloat(document.getElementById('expAmount').value);
            if(isNaN(amount)) return;
            const totalPath = `takamatsu_trip/expenses/${payer.toLowerCase()}`;
            onValue(ref(db, totalPath), (s) => set(ref(db, totalPath), (s.val()||0) + amount), {onlyOnce: true});
            push(ref(db, 'takamatsu_trip/expense_logs'), { payer, item, amount });
            document.getElementById('expItem').value = ""; document.getElementById('expAmount').value = "";
        };

        window.updateNames = () => {
            set(ref(db, 'takamatsu_trip/names'), { a: document.getElementById('nameA').value, b: document.getElementById('nameB').value });
        };

        window.deleteExpense = (id, payer, amount) => {
            remove(ref(db, `takamatsu_trip/expense_logs/${id}`));
            const path = `takamatsu_trip/expenses/${payer.toLowerCase()}`;
            onValue(ref(db, path), (s) => set(ref(db, path), Math.max(0, (s.val()||0) - amount)), {onlyOnce: true});
        };
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FFFFFF; color: #333; }
        .font-cursive { font-family: 'Dancing Script', cursive; }
        .active-tab { color: #B4A582 !important; border-bottom: 2px solid #B4A582 !important; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: none; overflow-y: auto; }
        input, select {
            background-color: #FDFBF7 !important; border: 1px solid #F0EBE0 !important;
            padding: 0.7rem 1rem 0.7rem 1.5rem !important; border-radius: 0.8rem !important; outline: none; width: 100%; font-size: 0.9rem;
        }
        .weather-box { font-size: 0.7rem; color: #B4A582; border: 1px solid #B4A582/20; padding: 4px 8px; border-radius: 10px; }
    </style>
</head>
<body class="max-w-md mx-auto">

    <header class="flex justify-between items-start p-6">
        <div>
            <h1 class="text-2xl font-black text-[#B4A582] leading-none">æ±äº¬â‡‹é«˜æ¾</h1>
            <p class="font-cursive text-lg text-[#B4A582] mt-1">Tokyo to Takamatsu</p>
        </div>
        <div class="flex gap-5 text-xl text-[#B4A582] pt-2">
            <button onclick="toggleOverlay('map-overlay', true)"><i class="fa-solid fa-map-location-dot"></i></button>
            <button onclick="toggleOverlay('expense-overlay', true)"><i class="fa-solid fa-wallet"></i></button>
        </div>
    </header>

    <div class="flex border-b border-gray-100 mb-6 px-6 overflow-x-auto">
        <button onclick="switchTab(1)" class="tab-btn active-tab flex-none pr-6 py-3 text-sm font-bold text-gray-400 text-left">Day 1<br><span class="text-[10px] font-normal">19/12 Fri</span></button>
        <button onclick="switchTab(2)" class="tab-btn flex-none pr-6 py-3 text-sm font-bold text-gray-400 text-left">Day 2<br><span class="text-[10px] font-normal">20/12 Sat</span></button>
        <button onclick="switchTab(3)" class="tab-btn flex-none pr-6 py-3 text-sm font-bold text-gray-400 text-left">Day 3<br><span class="text-[10px] font-normal">21/12 Sun</span></button>
    </div>

    <main class="px-6 pb-40">
        <div id="day1-panel" class="day-content">
            <div class="flex justify-end mb-4"><span class="weather-box">â˜€ï¸ 9-13Â°C / 0% é™é›¨</span></div>
            <div id="timeline-day1"></div>
            <div class="mt-8 space-y-2 bg-[#FDFBF7] p-5 rounded-3xl border border-[#B4A582]/10">
                <div class="grid grid-cols-2 gap-2">
                    <input type="time" id="time-day1">
                    <input type="text" id="loc-day1" placeholder="åœ°é»">
                </div>
                <input type="text" id="trans-day1" placeholder="äº¤é€š (ä¾‹: JR å¿«é€Ÿ Marine Liner)">
                <input type="text" id="note-day1" placeholder="å…§å®¹/ç­†è¨˜">
                <button onclick="addItem(1)" class="w-full bg-[#B4A582] text-white py-3 rounded-xl font-bold mt-2">ï¼‹ æ–°å¢è¡Œç¨‹</button>
            </div>
        </div>

        <div id="day2-panel" class="day-content hidden">
            <div class="flex justify-end mb-4"><span class="weather-box">â˜ï¸ 8-12Â°C / 20% é™é›¨</span></div>
            <div id="timeline-day2"></div>
            <div class="mt-8 space-y-2 bg-[#FDFBF7] p-5 rounded-3xl">
                <div class="grid grid-cols-2 gap-2"><input type="time" id="time-day2"><input type="text" id="loc-day2" placeholder="åœ°é»"></div>
                <input type="text" id="trans-day2" placeholder="äº¤é€šæ–¹å¼"><input type="text" id="note-day2" placeholder="å…§å®¹"><button onclick="addItem(2)" class="w-full bg-[#B4A582] text-white py-3 rounded-xl font-bold mt-2">ï¼‹ æ–°å¢è¡Œç¨‹</button>
            </div>
        </div>

        <div id="day3-panel" class="day-content hidden">
            <div class="flex justify-end mb-4"><span class="weather-box">â˜€ï¸ 7-11Â°C / 10% é™é›¨</span></div>
            <div id="timeline-day3"></div>
            <div class="mt-8 space-y-2 bg-[#FDFBF7] p-5 rounded-3xl">
                <div class="grid grid-cols-2 gap-2"><input type="time" id="time-day3"><input type="text" id="loc-day3" placeholder="åœ°é»"></div>
                <input type="text" id="trans-day3" placeholder="äº¤é€šæ–¹å¼"><input type="text" id="note-day3" placeholder="å…§å®¹"><button onclick="addItem(3)" class="w-full bg-[#B4A582] text-white py-3 rounded-xl font-bold mt-2">ï¼‹ æ–°å¢è¡Œç¨‹</button>
            </div>
        </div>
    </main>

    <div id="expense-overlay" class="overlay p-8">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold text-[#B4A582]">ğŸ’° è²»ç”¨åˆ†å¸³</h2>
            <button onclick="toggleOverlay('expense-overlay', false)" class="text-3xl text-gray-300">&times;</button>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-6">
            <input type="text" id="nameA" placeholder="æˆå“¡ A" onchange="updateNames()"><input type="text" id="nameB" placeholder="æˆå“¡ B" onchange="updateNames()">
        </div>
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="bg-gray-50 p-4 rounded-2xl text-center"><p class="text-[10px] text-gray-400 display-name-a">A</p><p id="totalA" class="text-xl font-bold text-[#B4A582]">Â¥0</p></div>
            <div class="bg-gray-50 p-4 rounded-2xl text-center"><p class="text-[10px] text-gray-400 display-name-b">B</p><p id="totalB" class="text-xl font-bold text-[#B4A582]">Â¥0</p></div>
        </div>
        <div class="bg-[#FDFBF7] p-5 rounded-3xl border border-[#B4A582]/10 space-y-3">
            <input type="text" id="expItem" placeholder="æ”¯å‡ºé …ç›® (å¦‚ï¼šä¸€é¶´éª¨ä»˜é³¥)">
            <div class="flex gap-2">
                <select id="payerSelect" class="w-1/2"><option value="A">ç”± A æ”¯ä»˜</option><option value="B">ç”± B æ”¯ä»˜</option></select>
                <input type="number" id="expAmount" placeholder="é‡‘é¡" class="w-1/2">
            </div>
            <button onclick="addExpense()" class="w-full bg-[#B4A582] text-white py-4 rounded-xl font-bold shadow-md">è¨˜éŒ„æ”¯å‡º</button>
        </div>
        <div class="mt-10"><h3 class="text-xs font-bold text-gray-300 uppercase mb-4">æ”¯å‡ºæ­·å²</h3><div id="expense-logs"></div></div>
    </div>

    <div id="map-overlay" class="overlay p-8">
        <div class="flex justify-between items-center mb-8"><h2 class="text-2xl font-bold text-[#B4A582]">ğŸ“ è¡Œç¨‹åœ°é»</h2><button onclick="toggleOverlay('map-overlay', false)" class="text-3xl text-gray-300">&times;</button></div>
        <div class="bg-gray-50 rounded-3xl p-8 text-center text-sm text-gray-400">
            <p>é»æ“Šè¡Œç¨‹å¡ç‰‡æ—çš„ ğŸ“ åœ–ç¤º<br>å³å¯è‡ªå‹•åœ¨ Google åœ°åœ–ä¸­å®šä½ã€‚</p>
        </div>
    </div>

</body>
</html>
